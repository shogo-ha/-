<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>アンケート入力フォーム</title>
    <link rel="stylesheet" href="./css/common.css">
    <style>
        /* 追加スタイル */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            font-size: 1.2em;
            color: #666;
        }
        .config-selector {
            background: #f0f4f8;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .config-selector select {
            padding: 10px 20px;
            font-size: 1.1em;
            border: 1px solid #ccc;
            border-radius: 4px;
            margin-left: 10px;
        }
        .btn-sm {
            padding: 4px 10px;
            font-size: 0.85em;
        }
        .btn-outline {
            background: transparent;
            border: 1px solid #6c757d;
            color: #6c757d;
        }
        .btn-outline:hover {
            background: #6c757d;
            color: white;
        }
        .sub-question {
            margin-left: 30px;
            padding-left: 20px;
            border-left: 3px solid #e0e0e0;
        }
        .conditional {
            display: none;
        }
        .conditional.show {
            display: block;
        }
        .number-pair {
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
        }
        .number-field {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .number-field input {
            width: 100px;
            padding: 8px 12px;
            font-size: 1.1em;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .number-field .unit {
            color: #666;
        }
        .scale-input {
            padding: 10px 0;
        }
        .scale-labels {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            color: #666;
            font-size: 0.9em;
        }
        .scale-options {
            display: flex;
            justify-content: space-between;
            gap: 5px;
        }
        .scale-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
        }
        .scale-option input {
            margin-bottom: 5px;
        }
        .scale-value {
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ヘッダー -->
        <header class="header">
            <h1 id="surveyTitle">アンケート入力フォーム</h1>
            <div class="header-info">
                <span>未出力のデータ: <strong id="recordCount">0</strong>件</span>
                <button type="button" class="btn btn-sm btn-outline" onclick="surveyForm.showCompletedIds()">保存済みID</button>
                <span>現在: <strong id="currentIndicator">ID</strong></span>
                <span id="digitIndicator" class="digit-indicator" style="display:none;"></span>
            </div>
        </header>

        <!-- 編集モード表示 -->
        <div class="edit-mode-banner">
            編集中: ID <span id="editingId"></span>
            <button class="btn btn-secondary" onclick="surveyForm.cancelEdit()">キャンセル</button>
        </div>

        <!-- 調査選択（複数調査対応時） -->
        <div class="config-selector" id="configSelector" style="display:none;">
            <label>調査を選択:
                <select id="surveySelect" onchange="loadSurvey(this.value)">
                    <option value="">-- 選択してください --</option>
                </select>
            </label>
        </div>

        <!-- ID入力セクション -->
        <section id="idSection" class="id-section">
            <div class="id-input-group">
                <label for="respondentId">回答者ID</label>
                <input type="text" id="respondentId" class="id-input" placeholder="IDを入力" autocomplete="off">
                <span id="idError" class="error-text" style="display:none;"></span>
            </div>
        </section>

        <!-- フォーム本体（動的生成） -->
        <main id="formContainer">
            <div class="loading">読み込み中...</div>
        </main>

        <!-- 操作ボタン -->
        <div class="action-buttons">
            <button type="button" class="btn btn-primary" id="saveBtn" onclick="surveyForm.showConfirmModal()">
                保存 (Enter)
            </button>
            <button type="button" class="btn btn-secondary" onclick="surveyForm.showDataList()">
                未出力データ一覧
            </button>
            <button type="button" class="btn btn-success" onclick="surveyForm.exportCSV()">
                CSV出力
            </button>
            <button type="button" class="btn btn-danger" onclick="surveyForm.clearAllData()">
                全削除
            </button>
        </div>
    </div>

    <!-- 確認モーダル -->
    <div class="modal" id="confirmModal">
        <div class="modal-content">
            <h3>保存確認</h3>
            <p>ID: <strong id="confirmId"></strong> のデータを保存しますか？</p>
            <div class="modal-buttons">
                <button class="btn btn-primary" onclick="surveyForm.confirmAndSave()">保存 (Enter)</button>
                <button class="btn btn-secondary" onclick="surveyForm.closeConfirmModal()">キャンセル (Esc)</button>
            </div>
        </div>
    </div>

    <!-- 成功モーダル -->
    <div class="modal" id="successModal">
        <div class="modal-content">
            <h3>✓ 保存完了</h3>
            <p>ID: <strong id="savedId"></strong></p>
            <div class="modal-buttons">
                <button class="btn btn-primary" onclick="surveyForm.closeSuccessModal()">次の入力へ (Enter)</button>
            </div>
        </div>
    </div>

    <!-- データ一覧モーダル -->
    <div class="modal" id="dataListModal">
        <div class="modal-content modal-large">
            <h3>未出力データ一覧</h3>
            <div id="dataListContainer">
                <table class="data-list-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>入力日時</th>
                            <th>入力者</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="dataListBody"></tbody>
                </table>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="surveyForm.closeDataListModal()">閉じる (Esc)</button>
            </div>
        </div>
    </div>

    <!-- 削除確認モーダル -->
    <div class="modal" id="deleteConfirmModal">
        <div class="modal-content">
            <h3>削除確認</h3>
            <p>ID: <strong id="deleteTargetId"></strong> を削除しますか？</p>
            <div class="modal-buttons">
                <button class="btn btn-danger" onclick="surveyForm.confirmDelete()">削除 (Enter)</button>
                <button class="btn btn-secondary" onclick="surveyForm.closeDeleteConfirmModal()">キャンセル (Esc)</button>
            </div>
        </div>
    </div>

    <!-- トースト -->
    <div id="toast" class="toast"></div>

    <script src="./js/storage.js"></script>
    <script src="./js/survey-generator.js"></script>
    <script src="./js/survey-form.js"></script>
    <script>
        let surveyForm = null;
        
        // Electron環境かどうか
        const isElectron = window.electronAPI && window.electronAPI.isElectron;
        
        // 初期化
        async function init() {
            let surveyId = null;
            
            if (isElectron) {
                // Electron環境: configフォルダを直接スキャン
                surveyId = await detectSurveyConfigElectron();
            } else {
                // ブラウザ環境: URLパラメータまたはfetch
                const params = new URLSearchParams(window.location.search);
                surveyId = params.get('survey');
                
                if (!surveyId) {
                    surveyId = await detectSurveyConfigBrowser();
                }
            }
            
            if (surveyId) {
                await loadSurvey(surveyId);
            }
        }
        
        // Electron環境でのconfig検出
        async function detectSurveyConfigElectron() {
            const container = document.getElementById('formContainer');
            
            try {
                const result = await window.electronAPI.listConfigFiles();
                
                if (!result.success || result.files.length === 0) {
                    // デバッグ情報を表示
                    let debugInfo = '';
                    if (result.debug) {
                        debugInfo = `
                            <p style="font-size:12px; color:#666; margin-top:20px;">
                                <strong>デバッグ情報:</strong><br>
                                basePath: ${result.debug.basePath}<br>
                                configDir: ${result.debug.configDir}<br>
                                PORTABLE_EXECUTABLE_DIR: ${result.debug.portableDir || '(未設定)'}<br>
                                exePath: ${result.debug.exePath}
                            </p>
                        `;
                    }
                    if (result.error) {
                        debugInfo += `<p style="color:red;">${result.error}</p>`;
                    }
                    
                    container.innerHTML = `
                        <div class="error-message">
                            <h3>設定ファイルが見つかりません</h3>
                            <p>configフォルダにJSONファイルを配置してください。</p>
                            ${debugInfo}
                        </div>
                    `;
                    return null;
                }
                
                if (result.files.length === 1) {
                    return result.files[0];
                } else {
                    // 複数ファイルがある場合は選択画面を表示
                    const surveys = result.files.map(id => ({ id: id, name: id }));
                    showSurveySelector(surveys);
                    return null;
                }
            } catch (e) {
                console.error('Config detection error:', e);
                container.innerHTML = `
                    <div class="error-message">
                        <h3>設定読み込みエラー</h3>
                        <p>${e.message}</p>
                    </div>
                `;
                return null;
            }
        }
        
        // ブラウザ環境でのconfig検出（従来のロジック）
        async function detectSurveyConfigBrowser() {
            const container = document.getElementById('formContainer');
            
            try {
                // config/index.jsonからファイル一覧を取得（存在する場合）
                const indexResponse = await fetch('../config/index.json');
                if (indexResponse.ok) {
                    const indexData = await indexResponse.json();
                    if (indexData.surveys && indexData.surveys.length > 0) {
                        if (indexData.surveys.length === 1) {
                            return indexData.surveys[0].id;
                        } else {
                            showSurveySelector(indexData.surveys);
                            return null;
                        }
                    }
                }
            } catch (e) {
                // index.jsonがない場合は個別ファイルを試行
            }
            
            // 一般的なファイル名パターンを試行
            const patterns = await scanConfigFolder();
            
            if (patterns.length === 0) {
                container.innerHTML = `
                    <div class="error-message">
                        <h3>設定ファイルが見つかりません</h3>
                        <p>configフォルダにJSONファイルを配置してください。</p>
                        <p>または config/index.json でファイル一覧を指定してください。</p>
                    </div>
                `;
                return null;
            } else if (patterns.length === 1) {
                return patterns[0];
            } else {
                // 複数ファイルがある場合は選択画面を表示
                const surveys = patterns.map(id => ({ id: id, name: id }));
                showSurveySelector(surveys);
                return null;
            }
        }
        
        // dataフォルダ内のJSONファイルをスキャン（ブラウザ環境用）
        async function scanConfigFolder() {
            const found = [];
            
            // よくあるファイル名パターンを試行
            const commonPatterns = [
                'survey_needs',
                'survey_kaigoyobo',
                'survey_config',
                'survey',
                'config'
            ];
            
            // まず一般的なパターンを試す
            for (const pattern of commonPatterns) {
                try {
                    const response = await fetch(`../config/${pattern}.json`, { method: 'HEAD' });
                    if (response.ok) {
                        found.push(pattern);
                    }
                } catch (e) {
                    // 無視
                }
            }
            
            // 見つからない場合、ディレクトリリストを試みる（一部サーバーで動作）
            if (found.length === 0) {
                try {
                    const response = await fetch('../config/');
                    if (response.ok) {
                        const text = await response.text();
                        // HTMLからJSONファイル名を抽出
                        const matches = text.match(/href="([^"]+\.json)"/g);
                        if (matches) {
                            for (const match of matches) {
                                const filename = match.match(/href="([^"]+\.json)"/)[1];
                                const id = filename.replace('.json', '');
                                if (!found.includes(id)) {
                                    found.push(id);
                                }
                            }
                        }
                    }
                } catch (e) {
                    // 無視
                }
            }
            
            return found;
        }
        
        // 調査選択UIを表示
        function showSurveySelector(surveys) {
            const selector = document.getElementById('configSelector');
            const select = document.getElementById('surveySelect');
            const container = document.getElementById('formContainer');
            
            // オプションを追加
            select.innerHTML = '<option value="">-- 選択してください --</option>';
            for (const survey of surveys) {
                const option = document.createElement('option');
                option.value = survey.id;
                option.textContent = survey.name || survey.id;
                select.appendChild(option);
            }
            
            selector.style.display = 'block';
            container.innerHTML = '<div class="loading">上のドロップダウンから調査を選択してください</div>';
        }
        
        // 調査を読み込み
        async function loadSurvey(surveyId) {
            if (!surveyId) return;
            
            const container = document.getElementById('formContainer');
            container.innerHTML = '<div class="loading">読み込み中...</div>';
            
            try {
                let config;
                
                if (isElectron) {
                    // Electron環境: IPCで読み込み
                    const result = await window.electronAPI.loadConfig(surveyId + '.json');
                    if (!result.success) {
                        throw new Error(result.error || '設定ファイルが見つかりません');
                    }
                    config = result.data;
                } else {
                    // ブラウザ環境: fetchで読み込み
                    const response = await fetch(`../config/${surveyId}.json`);
                    if (!response.ok) {
                        throw new Error('設定ファイルが見つかりません');
                    }
                    config = await response.json();
                }
                
                // タイトル更新
                document.getElementById('surveyTitle').textContent = config.surveyName;
                document.title = config.surveyName + ' 入力フォーム';
                
                // フォーム生成
                const generator = new SurveyGenerator(config);
                generator.generate(container);
                
                // フォーム初期化
                const formConfig = generator.getFormConfig();
                surveyForm = new SurveyForm(formConfig);
                surveyForm.init();
                
            } catch (error) {
                console.error('Failed to load survey:', error);
                container.innerHTML = `
                    <div class="error-message">
                        <h3>読み込みエラー</h3>
                        <p>${error.message}</p>
                        <p>設定ファイル: config/${surveyId}.json</p>
                    </div>
                `;
            }
        }
        
        // ページ読み込み時に初期化
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
