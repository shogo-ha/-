# 汎用アンケート入力フォーム（テンプレート版）

住民アンケート等の紙回答をPC入力・集計するためのWebアプリケーションです。

---

## フォルダ構成

```
SurveyApp/
├── start.bat                  ← ダブルクリックで起動
├── config/
│   └── survey_xxx.json        ← 設定JSONを配置
├── data/
│   └── _csv/                  ← CSV出力ファイルを格納（集計用）
├── _admin/                    ← 管理者用（集計処理）
│   ├── 集計処理.bat           ← CSVをExcelに統合
│   ├── output/                ← 統合結果の出力先
│   │   └── template/          ← テンプレートExcel
│   └── scripts/
│       └── aggregate_survey.py
├── _docs/                     ← ドキュメント
│   ├── README.md              ← このファイル
│   ├── AI_PROMPT_TEMPLATE.md  ← JSON生成用プロンプト
│   └── survey_original/       ← 元のアンケート原本を格納
└── _systems/                  ← システムファイル（編集不要）
    ├── index.html
    ├── css/
    └── js/
```

---

## 起動方法

### 1. JSONファイルを準備

1. `_docs/AI_PROMPT_TEMPLATE.md` とアンケートのPDF/docxをAIへ添付
2. 生成されたJSONを `config/` フォルダに格納
3. 元のアンケート原本は `_docs/survey_original/` に保管（任意）

### 2. アプリを起動

**`start.bat` をダブルクリック**

- ブラウザが自動で開きます
- 黒いウィンドウ（コマンドプロンプト）は使用中は閉じないでください
- 終了時は黒いウィンドウを閉じてください

> **必要環境:** Python  
> https://www.python.org/downloads/ からインストール  
> インストール時に「Add Python to PATH」にチェック

### 3. 入力者名の設定

起動時にWindowsのユーザー名が自動で設定されます。

手動で変更したい場合はURLパラメータで指定：

```
http://localhost:9000/_systems/index.html?operator=山田太郎
```

CSV出力時のファイル名に反映されます。

### 4. 複数人での同時利用

- アプリは自動で空きポートを探索します（9000 → 9001 → 9002...）
- 同じPCで複数人が起動しても競合しません
- 各自に異なるポート番号が割り当てられます

---

## 設定ファイル（JSON）の配置

`config/` フォルダにJSONファイルを配置すると自動で認識されます。

| 状況 | 動作 |
|------|------|
| 1ファイルのみ | 自動で読み込み |
| 複数ファイル | 選択画面を表示 |
| ファイルなし | エラーメッセージ表示 |

### 任意: index.json で一覧を定義

複数の調査を管理する場合：

```json
{
  "surveys": [
    {"id": "survey_kaigo", "name": "介護予防調査"},
    {"id": "survey_needs", "name": "ニーズ調査"}
  ]
}
```

---

## 操作方法

### キーボード操作

| キー | 動作 |
|------|------|
| 数字キー（1, 2, 3...） | 選択肢を選択 |
| Tab | 次の設問へ |
| Shift + Tab | 前の設問へ |
| Enter | 保存確認画面 |

### 入力の流れ

1. **ID入力**（必須）→ Tabで次へ
2. 各設問に回答（数字キーまたはクリック）
3. 最後にEnterで保存

### 表形式の設問

- 現在の入力行が黄色でハイライトされます
- 数字キーで列を選択すると自動で次の行へ
- クリック操作も可能です

### 10個以上の選択肢がある場合

- 2桁の選択肢は連続入力で選択（例: `1` → `5` で「15」）
- 待機は必要な範囲のみ（選択肢15個なら `1` のみ待機、`2〜9` は即時）
- 待機中に次の数字を押さなければ1桁として確定

---

## データ管理

### 保存先

- ブラウザのローカルストレージに自動保存
- 同じPC・同じブラウザで次回も継続可能

### CSV出力

- 「CSV出力」ボタンでExcel用ファイルを生成
- 4行ヘッダー形式（大問/空白/小問/選択肢番号）

**ファイル名形式:**
```
{調査名}_{日付}_{入力者}_{件数}件.csv
例: hashikami_needs_2025_20250129_山田太郎_15件.csv
```

### データ削除

- 「データ一覧」から個別削除可能
- 「全削除」で全件クリア

---

## 集計処理（CSV → Excel統合）

### 手順

1. 各入力者のCSVファイルを `data/_csv/` フォルダに格納
2. `_admin/集計処理.bat` をダブルクリック
3. `_admin/output/` に統合Excelが生成される

### 出力ファイル

| ファイル | 場所 | 説明 |
|----------|------|------|
| テンプレート | `_admin/output/template/` | 空のExcel（初回のみ生成） |
| 統合ファイル | `_admin/output/` | 全CSVを統合したExcel |

### 重複ID

- 同じIDが複数ある場合、該当行が黄色でハイライトされます

---

## トラブルシューティング

### ブラウザが開かない

1. 手動でブラウザを起動
2. `http://localhost:9000/_systems/index.html` にアクセス
3. ポート番号は黒いウィンドウに表示されています

### 「設定ファイルが見つかりません」

- `config/` フォルダにJSONファイルがあるか確認
- ファイル名に日本語や空白が含まれていないか確認

### ポートエラー

- 既に起動中のウィンドウがないか確認
- PCを再起動して再試行

### 集計処理でエラーが出る

- Pythonがインストールされているか確認
- `openpyxl` がない場合: `pip install openpyxl` を実行

---

## セキュリティについて

- ローカルサーバーは `localhost` のみでリッスン
- 外部ネットワークからのアクセスは不可
- データはPC内のブラウザに保存（サーバーには送信されません）
